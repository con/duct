# jsonargparse Integration TODOs

This file tracks remaining work for the jsonargparse config file support feature.

## Background

We've added jsonargparse support to duct to enable YAML config files. The integration is conditional - duct falls back to standard argparse when jsonargparse is not installed.

**What's done:**
- ✅ Added jsonargparse[yaml] to setup.cfg [all] extras
- ✅ Conditional import (HAS_JSONARGPARSE flag)
- ✅ ArgumentParser uses jsonargparse when available with `default_env=True` and `env_prefix='DUCT_'`
- ✅ Removed `os.getenv()` calls from argument defaults (now handled by jsonargparse)
- ✅ Added `--config` flag and default config paths:
  - `/etc/duct/config.yaml`
  - `${XDG_CONFIG_HOME:-~/.config}/duct/config.yaml`
  - `.duct/config.yaml`
- ✅ Added tests for config functionality
- ✅ Added `py3-minimal` tox environment for testing fallback mode
- ✅ Extended optional dependency testing pattern to yaml, matplotlib, and pyout
  - Added module-level import checks with None fallback in test_suite.py
  - Applied @pytest.mark.skipif decorators to tests requiring these dependencies
  - Tests gracefully skip when optional dependencies aren't installed

## Remaining Issues

### 1. ✅ FIXED: Enum type conversion for all enums

**Problem:** jsonargparse uses name-based enum lookup (`SessionMode["new-session"]`) while argparse uses value-based lookup (`SessionMode("new-session")`), causing failures when enum values differ from names.

**Solution implemented:**
- Created `StrEnum` base class with `.parse()` classmethod for value-based conversion
- All enums (Outputs, RecordTypes, SessionMode) now inherit from StrEnum
- Much cleaner than individual converter functions (DRY principle)
- Works with both argparse and jsonargparse
- No breaking changes to CLI interface
- Users can use natural values in both CLI and config files

**Commits:**
- `ec62d10` - Initial fix with individual converters
- `d08e944` - Refactored to StrEnum base class (cleaner approach)

**Tests added:**
- `test_record_types_argument_parsing` - CLI parsing with hyphenated values
- `test_enum_defaults_are_enum_instances` - Defaults are enum instances not strings
- `test_enum_conversion_from_config_file` - Config file parsing with jsonargparse
- `test_all_enum_values_from_config` - All enum variants work from config

### 2. ✅ FIXED/DOCUMENTED: Environment variable precedence

**Problem:** Environment variables were not working at all, and explicit --config overrides env vars.

**Root causes identified:**
1. ✅ FIXED: `env_prefix="DUCT_"` had trailing underscore, causing jsonargparse to look for `DUCT__SAMPLE_INTERVAL` instead of `DUCT_SAMPLE_INTERVAL`
   - Fixed by changing to `env_prefix="DUCT"` (without trailing underscore)

2. ⚠️ DOCUMENTED: jsonargparse treats `--config` as a CLI argument with higher precedence than env vars
   - This is a design decision by jsonargparse maintainers
   - See: https://github.com/omni-us/jsonargparse/issues/663
   - Their position: Applications should use `default_config_files` for config files
   - Workaround: Users can use `.duct/config.yaml` or other default paths where env vars DO override

**Solution implemented:**
- Fixed env_prefix to enable environment variable support
- Added comprehensive tests documenting expected vs actual precedence behavior
- Marked test for explicit --config behavior as xfail with link to upstream issue

**Precedence behavior (ACTUAL):**
- `default_config_files` < env vars < CLI args ✅ WORKING
- CLI args (including --config) > env vars > default_config_files ⚠️ jsonargparse design

**Tests added:**
- `test_config_precedence_without_explicit_config` - Tests default_config_files precedence (PASSES)
- `test_config_precedence_with_explicit_config` - Documents expected behavior for explicit --config (XFAIL)
- Created `jsonargparse-precedence/` directory with minimal reproducer for upstream discussion

### 3. ✅ FIXED: Config file behavior for missing files

**Problem:** Initial confusion about how jsonargparse handles missing config files.

**Actual behavior (CORRECT):**
- `default_config_files` - silently ignored if missing (works as expected)
- Explicit `--config` - fails if file doesn't exist (correct behavior, matches git/ssh/pytest conventions)

**Solution implemented:**
- Confirmed jsonargparse already handles this correctly by default
- Fixed test that incorrectly expected explicit `--config` to silently ignore missing files
- Added tests to verify correct behavior:
  - `test_explicit_config_missing_fails` - Explicit --config fails on missing file
  - `test_default_config_paths_missing_ignored` - Default paths silently skip missing
  - `test_default_config_in_cwd_loaded` - Default .duct/config.yaml gets loaded

**Config precedence (ACTUAL BEHAVIOR):**
1. Default config files (in order, skip if missing) ✅ WORKING
   - `/etc/duct/config.yaml`
   - `${XDG_CONFIG_HOME:-~/.config}/duct/config.yaml`
   - `.duct/config.yaml`
2. Environment variables (DUCT_*) override default config files ✅ WORKING
3. CLI arguments override everything ✅ WORKING
4. Explicit `--config` files treated as CLI args, override env vars ⚠️ jsonargparse design (see Issue #2)

### 4. ✅ FIXED: Update existing tests for jsonargparse error message format changes

**Problem:** jsonargparse produces different error messages than argparse.

**Solution implemented:**
- Made test assertions flexible to work with both argparse and jsonargparse formats
- Tests now check for key error indicators rather than exact message format

**Tests fixed:**
- `test_duct_unrecognized_arg` - Now checks for "unrecognized arguments" and "--unknown"
- `test_duct_missing_cmd` - Now checks for "command" and "required"
- `test_mode_invalid_value` - Already worked (substring match)

### 5. Replace conftest env vars with config file and opt-in decorator

**Problem:** Currently `test/conftest.py` sets `DUCT_SAMPLE_INTERVAL` and `DUCT_REPORT_INTERVAL` globally for all tests, which interferes with config precedence tests.

**Solution:**
- Create a test config file (e.g., `test/fixtures/test-config.yaml`) with fast test values
- Create an opt-in pytest decorator/fixture (e.g., `@pytest.mark.use_test_config` or `use_test_config` fixture)
- Tests that need fast intervals can opt-in explicitly
- Tests that need to test config precedence won't be affected

**Example approach:**
```python
# test/conftest.py
@pytest.fixture
def use_test_config():
    """Opt-in fixture for tests that need fast test intervals."""
    with mock.patch.dict(os.environ, {
        "DUCT_CONFIG_PATHS": str(Path(__file__).parent / "fixtures" / "test-config.yaml")
    }):
        yield

# test/test_something.py
def test_something_slow(use_test_config):
    # This test uses fast intervals from test-config.yaml
    ...
```

### 6. Add config file support to con-duct suite commands

**Scope:** Apply the same config file support to con-duct subcommands.

**Files to update:**
- `src/con_duct/suite/main.py` - main parser
- Individual command files (ls, plot, etc.)

**Config structure:**
```yaml
# Shared settings
log-level: INFO
colors: true

# con-duct subcommand settings (using dotted notation)
plot.min-ratio: 3.0
ls.format: auto
ls.fields: [command, exit_code, wall_clock_time]
```

**Environment variable mapping:**
- `DUCT_PLOT_MIN_RATIO` → `plot.min-ratio`
- `DUCT_LS_FORMAT` → `ls.format`

## Config File Format Notes

**Important:** Config file keys use **underscores**, not hyphens!

```yaml
# CORRECT:
sample_interval: 2.5
report_interval: 120.0

# WRONG (will fail):
sample-interval: 2.5
report-interval: 120.0
```

This is because jsonargparse maps to Python attribute names (e.g., `args.sample_interval`), not CLI flag names (`--sample-interval`).

## Testing Strategy

**With jsonargparse (`tox -e py3`):**
- Config file loading works
- Environment variables work
- Precedence chain is correct
- `--config` flag works

**Without jsonargparse (`tox -e py3-minimal`):**
- Fallback to argparse works
- CLI arguments still parse correctly
- No config file support (expected)
- No env var support (acceptable limitation)

## References

- jsonargparse docs: https://jsonargparse.readthedocs.io/
- Our naming convention discussion: Use `DUCT_SUBCOMMAND_ARG` format
- Precedence: defaults < config files < env vars < CLI args
